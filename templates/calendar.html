{% extends "base.html" %}

{% block title %}Calendar View{% endblock %}

{% block content %}
<div class="calendar-view">
    <h2>üìÖ Reservation Calendar</h2>
    
    {% if reservations %}
        <div class="timeline">
            {% set ns = namespace(has_current=false, first_upcoming_found=false) %}
            
            {# First pass: check if there's a current reservation #}
            {% for r in reservations %}
                {% if today and r.check_in <= today < r.check_out %}
                    {% set ns.has_current = true %}
                {% endif %}
            {% endfor %}
            
            {% for reservation in reservations %}
                {% set is_current = today and reservation.check_in <= today < reservation.check_out %}
                {% set is_past = today and reservation.check_out <= today %}
                {% set is_next_upcoming = false %}
                
                {# Mark first upcoming reservation only if no current reservation exists #}
                {% if today and not ns.has_current and not is_past and not ns.first_upcoming_found and reservation.check_in > today %}
                    {% set is_next_upcoming = true %}
                    {% set ns.first_upcoming_found = true %}
                {% endif %}
                
                <div class="timeline-item {% if is_current %}current-reservation{% elif is_past %}past-reservation{% elif is_next_upcoming %}next-upcoming{% endif %}" 
                     id="{% if is_current %}current-res{% elif is_next_upcoming %}next-res{% endif %}">
                    <div class="timeline-marker {{ reservation.platform }}"></div>
                    <div class="timeline-content">
                        <div class="timeline-header">
                            <h3>
                                {{ reservation.guest_name }}
                                
                                {# BADGE LOGIC - SIMPLIFIED #}
                                {% if is_current %}
                                    <span class="status-badge current-badge">üü¢ Currently Here</span>
                                {% endif %}
                                
                                {% if is_past %}
                                    <span class="status-badge past-badge">‚úì Completed</span>
                                {% endif %}
                            </h3>
                            <span class="platform-badge {{ reservation.platform }}">
                                {% if reservation.platform == 'airbnb' %}
                                    üè† Airbnb
                                {% else %}
                                    üìÖ Booking.com
                                {% endif %}
                            </span>
                        </div>
                        <div class="timeline-dates">
                            <span class="date-in">üì• Check-in: {{ reservation.check_in.strftime('%B %d, %Y') }}</span>
                            <span class="date-out">üì§ Check-out: {{ reservation.check_out.strftime('%B %d, %Y') }}</span>
                            <span class="duration">
                                ({{ (reservation.check_out - reservation.check_in).days }} night{{ 's' if (reservation.check_out - reservation.check_in).days != 1 else '' }})
                            </span>
                        </div>
                        <div class="timeline-details">
                            <p>üë§ {{ reservation.adults }} adult{{ 's' if reservation.adults != 1 else '' }}
                            {% if reservation.children > 0 %}
                                , üë∂ {{ reservation.children }} child{{ 'ren' if reservation.children != 1 else '' }}
                            {% endif %}
                            </p>
                            {% if reservation.special_requests %}
                                <p><strong>Special Requests:</strong> {{ reservation.special_requests }}</p>
                            {% endif %}
                            {% if reservation.notes %}
                                <p><strong>Notes:</strong> {{ reservation.notes }}</p>
                            {% endif %}
                        </div>
                        {% if is_admin %}
                        <div class="timeline-actions">
                            <a href="{{ url_for('edit_reservation', id=reservation.id) }}" class="btn-edit">Edit</a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <p>üì≠ No reservations to display</p>
            {% if is_admin %}
            <a href="{{ url_for('add_reservation') }}" class="btn-primary">Add Reservation</a>
            {% endif %}
        </div>
    {% endif %}
</div>

<style>
/* Current Reservation Highlighting */
.timeline-item.current-reservation .timeline-content {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%) !important;
    border: 3px solid #28a745 !important;
    box-shadow: 0 0 20px rgba(40, 167, 69, 0.3);
    animation: pulse-green 2s infinite;
}

.timeline-item.current-reservation .timeline-marker {
    background: #28a745 !important;
    box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);
    animation: pulse-marker 2s infinite;
}

@keyframes pulse-green {
    0%, 100% {
        box-shadow: 0 0 20px rgba(40, 167, 69, 0.3);
    }
    50% {
        box-shadow: 0 0 30px rgba(40, 167, 69, 0.6);
    }
}

@keyframes pulse-marker {
    0%, 100% {
        box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);
    }
    50% {
        box-shadow: 0 0 25px rgba(40, 167, 69, 0.8);
    }
}

/* Past Reservation Styling */
.timeline-item.past-reservation .timeline-content {
    background: #e9ecef !important;
    border-color: #ced4da !important;
    opacity: 0.7;
}

.timeline-item.past-reservation .timeline-marker {
    background: #6c757d !important;
}

.timeline-item.past-reservation .timeline-dates,
.timeline-item.past-reservation .timeline-details {
    color: #6c757d !important;
}

.timeline-item.past-reservation .timeline-dates span,
.timeline-item.past-reservation .timeline-details p {
    color: #6c757d !important;
}

.timeline-item.past-reservation .platform-badge {
    opacity: 0.6;
}

/* Status Badges */
.status-badge {
    display: inline-block !important;
    padding: 0.4rem 0.9rem !important;
    border-radius: 20px !important;
    font-size: 0.9rem !important;
    font-weight: 700 !important;
    margin-left: 0.7rem !important;
}

.current-badge {
    background: #28a745 !important;
    color: white !important;
    animation: pulse-badge 2s infinite;
}

.past-badge {
    background: #6c757d !important;
    color: white !important;
}

@keyframes pulse-badge {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.8;
    }
}

/* Smooth scroll behavior */
html {
    scroll-behavior: smooth;
}
</style>

<script>
// Auto-scroll to current or next upcoming reservation
document.addEventListener('DOMContentLoaded', function() {
    const currentRes = document.getElementById('current-res');
    if (currentRes) {
        setTimeout(function() {
            currentRes.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        }, 300);
    } else {
        const nextRes = document.getElementById('next-res');
        if (nextRes) {
            setTimeout(function() {
                nextRes.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }, 300);
        }
    }
});
</script>
{% endblock %}
